
	<script src="__JS__/jQuery/jquery.js"></script>

	<script type="text/javascript">
		<?php
			if ( empty( $class['type'] ) ){
				$type = $vo['type'];
			}else{
				$type = $class['type'];
			}
		?>
		function getComment(p){
			$('#commentlist').before("<div id='loading_comment'>loading...</div>");
			$.ajax({
				url : "{:U('comment/index')}",
				data : { comment : {$vo.id}, p : p, fst : "{$type}" },
				dataType : "json",
				type : "GET",
				success : function(c){
					var element = '<ul>';
					if (c.status == 0){
						element += '<li>' + c.data + '</li>';
					}else{
						for( i = 0; i < c.data.length; i++ ){
							if ((i%2) == 0){
								element += "<li class='even'>";
							}else{
								element += "<li>";
							}
							element += "<div class='r_box'>";
							element += "<h5 class='r_tit'><span>" + c.data[i].username + "</span> &nbsp; " + c.data[i].dtime + " &nbsp; / &nbsp; <a href='javascript:;' rel='"+c.data[i].id+"' class='reply_comment'>回复</a></h5>";
							element += "<div class='msgcot'>";
							element += c.data[i].msg;
							if (typeof(c.data[i].sondata) != 'undefined' && c.data[i].sondata != null){
								for (var e = 0; e < c.data[i].sondata.length; e++){
									element += "<div class='replycom'>";
									element += "<img src='http://www.gravatar.com/avatar/" + c.data[i].sondata[e].email + "?s=40&r=g' />";
									element += "<div class='rightbox'>";
									element += "<h4><span class='repname'>"+c.data[i].sondata[e].username+"</span> 于 <span class='reptime'>"+c.data[i].sondata[e].dtime+"</span> 回复 <span class='urname'>"+c.data[i].username+"</span></h4>";
									element += "<div class='repmsg'>"+c.data[i].sondata[e].msg+"</div>";
									element += "</div>";
									element += "<div class='clear'></div>";
									element += "</div>";
								}
							}
							element += "</div>";
							element += "</div>";
							element += "<img src='http://www.gravatar.com/avatar/" + c.data[i].email + "?s=40' />";
							element += "<div class='clear'></div>";
							element += "</li>";	
						}
						if ( c.info != '' ){
							$('#comment_page').html('<div class="page" style="margin:0!important;">'+ c.info +'<div class="clear"></div></div>');
						}
					}
					element += '</ul>';
					
					$("#comment_list").html(element);
					$('#loading_comment').remove();
				},
				cache : false
			});
		}

		$(function(){

			function checkForm(){
				if($.trim($("#e_textarea").val()) == ''){
					alert("评论内容不能为空");
					$("#e_textarea").focus();
					return false;
				}
			}
			
			function complete(msg){
			    if(msg.status == 0){
			        alert(msg.info);
                    return false;
			    }else{
					getComment(1);
                    fleshVerify();
                    $("#username").attr("value",'');
                    $("#e_textarea").attr("value",'');
                    $("#verify").attr("value",'');
                }
			}

			getComment(1);
			
			$('#postcomment').submit(function(){
				
				var username = $.trim($("#username").val());
				var email = $.trim($("#email").val());
				var verify = $.trim($("#verify").val());
				var e_textarea = $.trim($("#e_textarea").val());
				
				$.ajax({
					url : '{:U("comment/insert")}',
					dataType : 'json',
					data : {
						username : username, 
						email : email, 
						msg : e_textarea, 
						verify : verify, 
						cid : '{$vo.id}', 
						arctitle : '{$vo.title}',
						type : '{$type}'
					},
					type : 'POST',
					beforeSend : checkForm,
					success : complete,
					cache : false
				});
				
				return false;
			});
			$("#reply_post").live('click',function(){
			
				var usernameReply = $.trim($("#usernameReply").val());
				var emailReply = $.trim($("#emailReply").val());
				var e_textareaReply = $.trim($("#e_textareaReply").val());
				var verifyReply = $.trim($('#verifyReply').val());
				var reply_pid	= $('#reply_pid').val();
				var e_url = '{:U("comment/reply")}';
				
				if(e_textareaReply == ''){
					alert("评论内容不能为空");
					$("#e_textareaReply").focus();
					return false;
				}
				
				$.ajax({
					url : e_url,
					dataType : 'json',
					data : { username : usernameReply, email : emailReply, msg : e_textareaReply, verify : verifyReply, pid : reply_pid, cid : '{$vo.id}', arctitle : '{$vo.title}' },
					type : 'POST',
					success : function (e){
						if(e.status == 0){
				        	alert(e.info);
	                        return false;
					    }else{
					    	$("#reply_comment").remove();
	    					getComment(1);
	                    }
					},
					cache : false
				});
				return false;
			});
			$(".reply_comment").live('click',function(){
				var id = $(this).attr("rel");
				var isreply = $("#reply_comment").length;
				if ($("#reply_pid").val() == id){
					$("#reply_comment").remove();
					return false;
				}
				if (isreply > 0){
					$("#reply_comment").remove();
				}
				
				var html = '<div id="close_reply" style="cursor: pointer;">关闭</div>';
				html += '<form method="post" id="reply_comment_post">';
				html += '<table border="0" cellpadding="0" cellspacing="0" style="width:100%;">';
				html += '	<tr>';
				html += '		<td><input name="username" id="usernameReply" class="txt" value="" style="width:280px;" /> &nbsp; *用户名</td>';
				html += '	</tr>';
				html += '	<tr>';
				html += '		<td><input name="email" id="emailReply" class="txt" value="" style="width:280px;" /> &nbsp; *邮箱</td>';
				html += '	</tr>';
				<?php if( C('COMMENT_VERIFY') == 1 ){ ?>
				html += '	<tr>';
				html += '		<td><input type="text" name="verify" id="verifyReply" class="txt" style="width:200px;" /> &nbsp; <img id="verifyImgReply" SRC="index.php?m=comment&a=verify" onClick="fleshVerifyReply()" BORDER="0" ALT="点击刷新验证码" style="cursor:pointer;" align="absmiddle"></td>';
				html += '	</tr>';
				<?php } ?>
				html += '	<tr>';
				html += '		<td class="tdpd"><textarea class="txtarea" name="msg" id="e_textareaReply" class="txt" style="height:120px; width:97%;"></textarea></td>';
				html += '	</tr>';
				html += '	<tr>';
				html += '		<td class="tdpd"><input type="submit" class="do_post_com" id="reply_post" value="Reply" /></td>';
				html += '	</tr>';
				html += '</table>';
				html += '<input type="hidden" value="'+id+'" name="pid" id="reply_pid" />';
				html += '</form>';
				
				$(this).parent().parent().parent().after("<div id='reply_comment'>"+html+"</div>");
				fleshVerifyReply();
			});
			$("#close_reply").live('click',function(){
				$(this).parent().remove();
			});
		});

		function fleshVerify(type){ 
			var timenow = new Date().getTime();
			$("#verifyImg").attr("src","index.php?m=comment&a=verify&"+timenow);
		}
		
		function fleshVerifyReply(){
			var timenow = new Date().getTime();
			$("#verifyImgReply").attr("src","index.php?m=comment&a=verify&"+timenow);
		}
	</script>
	<div id="comment">

		<h3 class="comment_title">评论</h3>
		<div id="comment_list"></div>
		<div id="comment_page"></div>
		<?php if( C('COMMENT_ON_OFF') == 1 ){ ?>
		<div id="comment_form" class="efbox">
			<form method="post" id="postcomment">
				<table border="0" cellpadding="0" cellspacing="0">
					<tr>
						<td><input name="username" id="username" class="txt" value="" style="width:280px;" /> &nbsp; *用户名</td>
					</tr>
					<tr>
						<td><input name="email" id="email" class="txt" value="" style="width:280px;" /> &nbsp; *邮箱</td>
					</tr>
					<?php if( C('COMMENT_VERIFY') == 1 ){ ?>
					<tr>
						<td><input type="text" name="verify" id="verify" class="txt" style="width:200px;" /> &nbsp; <img id="verifyImg" SRC="{:U("comment/verify")}" onClick="fleshVerify()" BORDER="0" ALT="点击刷新验证码" style="cursor:pointer;" align="absmiddle"></td>
					</tr>
					<?php } ?>
					<tr>
						<td><textarea class="txtarea" name="msg" id="e_textarea" class="txt" style="height:120px;"></textarea></td>
					</tr>
					<tr>
						<td><input type="submit" class="do_post_com" value="提交评论" /></td>
					</tr>
				</table>
			</form>
		</div>
		<?php } ?>
	</div>
