<!DOCTYPE html>
<html>
    <head>
        <title>{$class['name']} > {:C('SITE_TITLE')}</title>
        <link href="../Public/style/other.css" type="text/css" rel="stylesheet" />
        <link href="__PUBLIC__/editor/themes/default/default.css" rel="stylesheet" />
        <script type="text/javascript" src="__JS__/jQuery/jquery.js"></script>
		<script charset='utf-8' src='__PUBLIC__/editor/kindeditor.js'></script>
        <script charset='utf-8' src='__PUBLIC__/editor/lang/zh_CN.js'></script>
		<script type="text/javascript">
			
			$(function(){

                var editor = KindEditor.create("#bookcontent",{
                    items : ['forecolor', 'bold', 'italic', 'underline',
                        'removeformat', '|', 'justifyleft', 'justifycenter', 'justifyright', 'insertorderedlist',
                        'insertunorderedlist', '|', 'emoticons'],
                        minWidth : '460px',
                        width : '520px'
                });

                $('#insertGuestBook').submit(function(){
                	var _self = $(this);
                	$.ajax({
                		url : '{:U("insert")}',
                		dataType : 'json',
                		success : function(e){
                			if ( e.status == 0 ){
                				alert(e.data);
                				return false;
                			}else{
                				window.location.href = e.data;
                			}
                		},
                		type : 'POST',
                		//data : $('#insertGuestBook').serialize(),
                        data : { 
                            'username' : $('#username').val(), 
                            'email' : $('#email').val(), 
                            'verify' : $('#verify').val(), 
                            'content' : editor.html()
                        },
                		cache : false
                	});
                	return false;
                });
            });
            function fleshVerify(type){ 
				//重载验证码
				var timenow = new Date().getTime();
				if (type){
					$('#verifyImg').attr("src", 'index.php?m=guestbook&a=verify&adv=1&'+timenow);
				}else{
					$('#verifyImg').attr("src", 'index.php?m=guestbook&a=verify&'+timenow);
				}
			}
		</script>
    </head>
    <body>
        
        <include file="Public:header" />
        
        <div id="position">{$position}</div>
        
        <div id="body">
            <div id="content">
            	
            	<div id="guestbook_form" style="padding:20px; border-bottom:1px solid #ccc; border-top: 0;">
            		<form id="insertGuestBook">
					<table cellpadding="0" cellspacing="0" border="0">
						<tr>
							<td><input type="text" id="username" name="username" class="input" /> * 昵称</td>
							<td align="left" class="tit">&nbsp;</td>
						</tr>
						<tr>
							<td><input type="text" id="email" name="email" class="input" /> * 邮箱</td>
							<td align="left" class="tit">&nbsp;</td>
						</tr>
				        <tr>
				            <td><input type="text" name="verify" id="verify" class="input" style="float:left; margin-right:8px;" /><img id="verifyImg" SRC="index.php?m=guestbook&a=verify" onClick="fleshVerify()" BORDER="0" ALT="" style="cursor:pointer;" align="absmiddle"> * 验证码</td>
				            <td align="left" class="tit">&nbsp;</td>
				        </tr>
						<tr>
							<td><textarea class="input" id="bookcontent" name="content" rows="3" cols="30" style="height:180px;"></textarea></td>
							<td align="left" class="tit" valign="top"> * 留言内容</td>
						</tr>
						<tr>
							<td>
								<input type="submit" id="gbook_submit" class="submit" value="提交留言" />
							</td>
							<td align="right" class="tit">&nbsp;</td>
						</tr>
					</table>
					</form>
				</div>
	
                <ul class="glist">
                	<?php $i2 = 1; ?>
                	<volist name="list" id="vo">
                	<li class="list<?php if( ( $i2 % 2 ) == 0 ){ ?> Even<?php } ?>">
                		<div class="avatar"><img src="http://www.gravatar.com/avatar/{$vo.email|md5}?s=40" /></div>
                		<dl class="gdl">
                			<dt class="nom"><b>{$vo.username}</b> 于 {$vo.create_time|date='Y-m-d H:i:s',###} 说：</dt>
                			<dd class="nom">
                				{$vo.content}
                				<php>
                					$reply = $model->where("pid='".$vo['id']."'")->order('id DESC')->select();
                					if ( !empty( $reply ) ){
                				</php>
                				<ol class="list_v">
                					<volist name="reply" id="reply">
                					<li>
                						<div class="avatar"><img src="http://www.gravatar.com/avatar/{$reply.email|md5}?s=40" /></div>
                						<dl class="nom">
                							<dt class="nom"><b>{$reply.username}</b> 于 {$reply.create_time|date='Y-m-d H:i:s',###} 回复 <b>{$vo.username}</b></dt>
                							<dd class="nom">{$reply.content}</dd>
                						</dl>
                						<div class="clear"></div>
                					</li>
                					</volist>
                				</ol>
                				<php>
                					}
                				</php>
                			</dd>
                		</dl>
                		<div class="clear"></div>
                	</li>
                	<?php $i2++; ?>
                	</volist>
                </ul>
                <div class="page">{$page}</div>
            </div>
            
            <div id="slidebar">
                <include file="Public:slidebar" />
            </div>
            
            <div class="clear"></div>
        </div>
        
        <include file="Public:footer" />
        
    </body>
</html>