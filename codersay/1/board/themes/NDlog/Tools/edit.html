<!doctype html>
<html>
	<head>
		<title>{:C('SITE_TITLE')}</title>
		<meta charset="utf-8" />
		<include file="Public:commonjs" />
		<link rel="stylesheet" type="text/css" href="../Public/style/layout.css" />
		<script type="text/javascript" src="__JS__/jQuery/jquery.js"></script>
		<script type="text/javascript" src="__JS__/jQuery/plugin/cookie.js"></script>
		<script type="text/javascript" src="__JS__/jQuery/plugin/ajaxUpload.js"></script>
		<script type="text/javascript" src="__JS__/NDlogpublic.js"></script>
		<script type="text/javascript" src="../Public/js/common.js"></script>
		<script type="text/javascript">
			jQuery(document).ready(function($){
				$('form').submit(function(){
					var title = $('#title');
					var titval = $.trim(title.val());
			       	if ( titval == '' ){
			           	NDlog._showErrorInfo( title, '标题必须填写！' );
			           	return false;
			       	}
			       	if ( $('form').find('input[name="banner"]').length == 0 ){
			           	alert('未上传广告图片！')
			           	return false;
			       	}
			       	var url = $('input[name="url"]');
					var url_val = $.trim( url.val() );
					var exp = /http(s)?:\/\/([\w-]+\.)+[\w-]+(\/[\w- .\/?%&=]*)?/;
					var objExp = new RegExp(exp);
					if ( url_val == '' ){
						NDlog._showErrorInfo(url,'URL链接地址必须填写！');
						return false;
					}
					if( objExp.test(url_val) === false ){
						NDlog._showErrorInfo(url,'无效的链接地址，请正确填写！');
						return false;
					}
			   	});
			});
			function ajaxFileUpload(){
                if ($("#filedata").val() == ''){
                    alert('请选择要上传的文件！');
                    return false;
                }
                //starting setting some animation when the ajax starts and completes
                $("#loading").ajaxStart(function(){ $(this).show(); }).ajaxComplete(function(){ $(this).hide(); });
        
                $.ajaxFileUpload({
                    url:'{:U("uploadfile/upfile")}', 
                    secureuri:false,
                    fileElementId:'filedata',
                    dataType: 'json',
                    success: function (data, status){
                        //alert(data.msg.url);
                        if(typeof(data.error) != 'undefined'){
                            if(data.error != ''){
                                alert(data.error);
                            }else{
                                alert(data.msg);
                            }
                        }
                        $("#set_banner").after("<tr id='img_display'><td align='left'><img src='"+data.msg.url+"' /><input type='hidden' name='banner' value='"+data.msg.url+"' /></td></tr>");
                        $("#buttonUpload").attr("disabled","disabled");
                        $("#filedata").attr("disabled","disabled");
                        $("#buttonUpload").after(" &nbsp;&nbsp;&nbsp; <input type='button' class='attButton submit' id='removebanner' onclick=\"return removeFile();\" value='删除' />");
                    },
                    error: function (data, status, e){
                        alert(e);
                    }
                });
                return false;
            }
            function removeFile(){
				$.post("{:U('uploadfile/removefile')}",function(data){
					if ( data.status == 1 ){
						$("#buttonUpload").removeAttr("disabled");
						$("#filedata").removeAttr("disabled");
						$("#img_display").remove();
						$("#removebanner").remove();
					}
				},'json');
				return false;
			}

			function removeOFile($file,$id)
			{
				$.post("{:U('removeBanner')}",{id:$id,file:$file},function(data){
					if ( data.status == 1 ){
						$("#buttonUpload").removeAttr("disabled");
						$("#filedata").removeAttr("disabled");
						$("#img_display").remove();
						$("#removebanner").remove();
					}
				},'json');
				return false;
			}
		</script>
		<style type="text/css" media="all">
			.t_input	{ padding: 6px; }
		</style>
	</head>
	<body>
		<div id="wrap">
			<include file="Public:header" />
			<div id="container">
				<div id="sidebar_switch"></div>
				<div id="content">
					<div id="c_warp">
						<form action="{:U('update')}" method="post">
				    	<input type="hidden" name="id" id="id" value="{$vo.id}" />
			            <table class="table_form" cellpadding="0" cellspacing="0" border="0" width="100%">
			                <tr>
			                    <td align="left"><input type="text" name="title" id="title" class="t_input w480" value="{$vo.title}" /><p class="remark">广告标题</p></td>
			                </tr>
			                <tr>
			                    <td align="left"><input type="text" name="url" class="t_input w480" value="{$vo.url}" /><p class="remark">广告链接URL地址</p></td>
			                </tr>
			                <?php if( $type == 'focus' ) { ?>
			                <tr>
			                	<td align="left"><input type="text" name="type" class="t_input w280" value="{$vo.type}" /><p class="remark">自定义标识符，可用于读取某标识组图。</p></td>
			                </tr>
			                <?php 
			            		}
								if( !empty( $vo['banner'] ) ){
							?>
							<tr id="set_banner">
								<td>
								<span class="file_d_Upload">
									<input id="filedata" type="file" class="attText t_input" style="padding:2px;" name="filedata" disabled="disabled" />
									 &nbsp;&nbsp; 
									<input class="submit" type="button" id="buttonUpload" onclick="return ajaxFileUpload();" disabled="disabled" value="点击上传图片" />
									 &nbsp;&nbsp; 
									<input class='submit' type="button" id='removebanner' onclick="return removeOFile('{$vo.banner}','{$vo.id}');" value="删除" />
								</span>
								</td>
							</tr>
							<tr id='img_display'>
								<td>
									<p><img src='{$vo.banner}' /></p>
								</td>
							</tr>
							<?php
								}else{
							?>
								<tr id="set_banner">
									<td align="left">
										<span class="file_d_Upload">
											<input id="filedata" type="file" class="attText t_input" style="padding:2px;" name="filedata"> &nbsp;&nbsp;&nbsp; 
											<input type="button" class="attButton submit" id="buttonUpload" onclick="return ajaxFileUpload();" value="点击上传图片" />
										</span>
									</td>
								</tr>
							<?php
								}
							?>
			                
							<tr style="display:none;" id="loading">
								<td></td>
								<td align='left'><img src="__THEMES__/images/loading.gif" /></td>
							</tr>
			                <tr>
			                    <td align="left">
			                        <input type="radio" name="status" value="1"<?php if($vo['status'] == 1){ ?> checked="checked"<?php } ?> /> 显示 &nbsp;&nbsp;
			                        <input type="radio" name="status" value="0"<?php if($vo['status'] == 0){ ?> checked="checked"<?php } ?> /> 隐藏 &nbsp;&nbsp;
			                    </td>
			                </tr>
			                <tr>
			                    <td align="left"><textarea name="dsp" id="dsp" style="width: 90%; height:160px;" class="t_input">{$vo.dsp}</textarea><p class="remark">详细说明</p></td>
			                </tr>
			                <tr>
			                    <td align="left">
			                    	<input type="submit" class="submit" value="提交表单" />
			                    	&nbsp;&nbsp;&nbsp;
			                    	<input type="button" class="submit" value="返回" onclick="window.location.href='{:U('advs',array('type'=>$type,'node'=>$_GET['node']))}';" />
			                    </td>
			                </tr>
			            </table>
			            </form>
					</div>
				</div>
				<include file="Public:sidebar" />
			</div>
		</div>
	</body>
</html>