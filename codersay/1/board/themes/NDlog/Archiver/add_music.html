<!doctype html>
<html>
	<head>
		<title>{:C('SITE_TITLE')}</title>
		<meta charset="utf-8" />
		<include file="Public:commonjs" />
		<link rel="stylesheet" type="text/css" href="../Public/style/layout.css" />
		<script type="text/javascript" src="__JS__/jQuery/jquery.js"></script>
		<script type="text/javascript" src="__JS__/jQuery/plugin/cookie.js"></script>
		<script type="text/javascript" src="__JS__/NDlogpublic.js"></script>
		<script type="text/javascript" src="../Public/js/common.js"></script>
		<include file="Public:editor" />
		<script type="text/javascript">
			jQuery(document).ready(function($){
				editor = KindEditor.create("#textarea",{
					uploadJson:'{:U("uploadfile/uploadeditor")}',
					fileManagerJson:'{:U("filemanage/viewlist")}',
					allowFileManager : true,
					sessionid : '<?php echo $_COOKIE["PHPSESSID"];?>',
					afterUpload:function(data){ }
				});
				$('#music_search_input').bind({
					blur : function(){
						if ( $.trim( $(this).val() ) == '' ) $('#search_result').slideUp();
					},
					click : function(){
						$('#search_result').slideDown();
					},
					keypress : function(event){
						var keyCode = event.keyCode ? event.keyCode : event.which ? event.which : event.charCode;
						if ( keyCode == 13 ){
							if ( $.trim( $(this).val() ) != '' ) searchMusicList(1);
							return false;
						}
					}
				});

				$(".music_list li").live('click',function(){
					var PL =  '<embed src="http://www.xiami.com/widget/0_' + $(this).attr("id") + '/singlePlayer.swf" type="application/x-shockwave-flash" width="257" height="33" wmode="transparent"></embed>';
					PL += '<a href="javascript:;" title="重新搜索音乐" id="reSelectMusic"></a>';
					PL += '<input type="hidden" name="music" value="http://www.xiami.com/widget/0_' + $(this).attr("id") + '/singlePlayer.swf" />';
					$("#music_box").show().children('td').html(PL);
					$('#music_search_input').parent().hide();
					$('#search_result').hide();
				});
				
				$('#reSelectMusic').live('click',function(){
					$('#music_box').hide().children('td').html('');
					$('#music_search_input').parent().show();
					$('#search_result').show();
				});

				$('.more_title').click(function(){
					if ( $(this).hasClass('more_open') === false ){
						$(this).addClass('more_open').next('#more_option').slideDown();
					}else{
						$(this).removeClass('more_open').next('#more_option').slideUp();
					}
				});

				var $type = true;
                $('select[name="cid"]').find('option').each(function(){
                    if ( $(this).attr('disabled') !== undefined ){ $type = false; }
                });

                if( $type === false ){
                    $('input[name="type"]').after('<h3 style="padding-left:10px; color:red;">提示：还没有 music 类型的分类，请先添加分类。</h1>');
                }

				$('form').submit(function(){
				    var _title = $('input[name="title"]');
				    var _tit_val = $.trim( _title.val() );
				    
				    if ( $('select[name="cid"]').find('option:selected').attr('disabled') ){
                        var $html = '<h3>没有对应的分类，请先增加对应类型的分类。</h3>\
                                    <input type="text" class="t_input w280 mt" id="catalog_name" />\
                                    <input type="hidden" id="catalog_type" value="music" />\
                                    <input type="submit" id="catalog_submit" class="submit" value="提交" />';
                        var $dialog = $.dialog({
                            title : '增加分类',
                            content : $html
                        });

                        $('#catalog_submit').live('click',function(){
                            $.ajax({
                                url : '{:U("insertOneCatalog")}',
                                data : {
                                    name : $('#catalog_name').val(),
                                    type : $('#catalog_type').val()
                                },
                                cache : false,
                                type : 'POST',
                                success : function( $result ){
                                    if ( $result.status == 0 ){
                                        $.alert( $result.data ); return false;
                                    }else{
                                        $('input[name="type"]').next('h3').remove();
                                        $('select[name="cid"]').append('<option value="'+$result.data.id+'" selected="selected">'+$result.data.name+'</option>');
                                        $dialog.close();
                                    }
                                },
                                dataType : 'json'
                            });
                        });
                        return false;
                    }

				    if ( _tit_val == '' ){
				        NDlog._showErrorInfo( _title, '文档标题必须填写！' );
				        return false;
				    }
				    
				    if ( $('#music_box').children('td').html() == '' ){
				        NDlog._showErrorInfo( $('#music_search_input'), '没有添加音乐！' );
				        return false;
				    }
				});

                NDlog._checkErrorInput($('.error_input'));
			});
			var musicPage = 1;
			
			function searchMusicList(Page){
				searchMusicLoading(true);
				musicPage = Page;
				var head = "search_result";
				var src1 = "http://www.xiami.com/app/nineteen/search/key/"+ encodeURIComponent($('#music_search_input').val()) +"/page/"+ musicPage +"?random="+new Date().getTime()+".js&callback=getXiamiData";
				var JSONP = document.createElement("script") ;
				JSONP.type = "text/javascript";
				JSONP.src = src1;
				//在head之后添加js文件
				setTimeout(function(){document.getElementsByTagName("head")[0].appendChild(JSONP)}, 0);
				JSONP.onload = JSONP.onreadystatechange = function(){
					if (!this.readyState || this.readyState === "loaded" || this.readyState === "complete") {
						JSONP.onload = JSONP.onreadystatechange = null;//清内存，防止IE memory leaks
					}
				}
			}
			
			function searchMusicLoading(show) {
				if(show == true) {
					$('#search_status').html('正在搜索中……');
				} else {
					$('#search_status').html('');
				}
			}
			
			
			function getXiamiData(jsonData) {
				$('#music_list').html('');
				$('#self_set_pager_ui').html('');
				var __musicList = '';
				if(jsonData.total == 0) {
					__musicList = '抱歉，没有找到关于 <font color="red">'+ $('#music_search_input').val() +'</font> 的音乐。';
					$('#self_set_pager_ui').html('');
					// return false;
				} else {
					for(var i in jsonData.results){
						__musicList += '<li id="'+jsonData.results[i].song_id+'" name="'+ decodeURIComponent(jsonData.results[i].song_name) +' -- '+ decodeURIComponent(jsonData.results[i].artist_name)+'">'+ decodeURIComponent(jsonData.results[i].song_name) +' -- '+ decodeURIComponent(jsonData.results[i].artist_name)+'</li>';
					}
			
					// pager
					if(jsonData.total > 8) {
						$('#self_set_pager_ui').html( pagerView(parseInt(jsonData.total), parseInt(musicPage)) );
						$('.act_page').live('click',function(){
							var _getPageNum = $(this).attr('rel');
							searchMusicList(parseInt(_getPageNum));
						});
					} else {
						$('#self_set_pager_ui').html('');
					}
				}
				$('#music_list').html(__musicList);
				searchMusicLoading(false);
			}
			
			function pagerView(dataCount, currentPage){
				var __musicListPager = '<div class="pages" id="music_pager"><ul><li class="prevpage"><a href="javascript:void(0);" rel="'+ (currentPage <= 1 ? 1 : currentPage - 1) +'" title="上一页" class="act_page">上一页</a></li>';
			
				var __totalPage = dataCount/8;
				__totalPage = __totalPage > parseInt(__totalPage) ? parseInt(__totalPage) + 1 : parseInt(__totalPage);
				var __forLength = currentPage > 10 ? (currentPage > 1000 ? 2 : 3) : 4;
				var __forStep = 2;
				var __forStart = (__totalPage > 4 && currentPage > __forStep) ? (currentPage < __totalPage - __forLength ? currentPage - __forStep : __totalPage - __forLength) : 1;
				var __forEnd = __forStart + __forLength < __totalPage + 1 ? __forStart + __forLength + 1 : __totalPage + 1;
			
				if(__totalPage > 4 && currentPage > __forStep + 1) __musicListPager += '<li><a href="javascript:void(0)" rel="1" class="act_page">1...</a></li>';
			
				for ( var i = __forStart; i < __forEnd; i++ ) {
					if(currentPage == i) {
						__musicListPager += '<li><a href="javascript:void(0)" rel="'+ i +'" style="background-color:#839B1B; border:1px solid #839B1B;color: #FFFFFF" class="act_page">'+ i +'</a></li>';
					} else {
						__musicListPager += '<li><a href="javascript:void(0)" rel="'+ i +'" class="act_page">'+ i +'</a></li>';
					}
				}
			
				if(__forEnd < __totalPage) __musicListPager += '<li><a href="javascript:void(0)" rel="'+ __totalPage +'" class="act_page">...'+ __totalPage +'</a></li>';
			
				if(currentPage < __totalPage) {
					currentPage++
					__musicListPager += '<li class="nextpage"><a href="javascript:void(0)" title="下一页" rel="'+ currentPage +'" class="act_page">下一页</a></li>';
				}
				__musicListPager += '<li class="lastpage"><a href="javascript:void(0)" title="最后一页" rel="'+ __totalPage +'" class="act_page">最后一页</a></li></ul></div>';
				return __musicListPager;
			}
		</script>
		<style type="text/css">
			.t_input				{ padding: 6px; }
			#search_result 				{ border:1px solid #ccc; width:380px; height:310px; overflow:auto; position: absolute; background:#f9f9f9; z-index: 999; }
			.music_list 				{ width:350px; overflow:hidden; margin:0 auto; }
			.music_list li 				{ clear:both; padding:8px 0px; border-bottom:1px dotted #ccc; overflow:hidden; text-align:left; cursor:pointer; }
			.pages 						{ margin:15px; zoom:1; overflow:hidden; }
			.pages ul 					{ height:21px; overflow:hidden; }
			.pages li 					{ float:left; margin-right:2px; height:21px; line-height:21px; overflow:hidden; }
			.pages li a 				{ float:left; padding:0 6px; height:19px; line-height:19px; border:1px solid #E3E4DD; text-decoration:none; vertical-align:middle; overflow:hidden; color:#666; }
			.pages li a, .pages li a:visited {color:#666;}
			.pages li a:hover 			{ text-decoration:none; border-color:#839B1B; color:#FFF; background-color:#839B1B; }
			.pages .select 				{ background-color:#839B1B; }
			.pages .select a , .pages .select a:visited {color:#FFF; border:1px solid #839B1B;}
			#music_box					{ display: none; }
			#reSelectMusic				{ width: 16px; height:16px; background:url(../Public/images/reselect.png) no-repeat; position: absolute; left:280px; top:10px; }
		</style>
	</head>
	<body>
		<div id="wrap">
			<include file="Public:header" />
			<div id="container">
				<div id="sidebar_switch"></div>
				<div id="content">
					<div id="c_warp">
						<form action="{:U('insert')}" method="post">
						<input type="hidden" name="type" value="music" />
						<table class="table_form" cellpadding="0" cellspacing="0" border="0" width="100%">
                            <tr>
                                <td><input type="text" name="title" id="title" class="t_input w480" /><p class="remark">文档标题，必须填写</p></td>
                            </tr>
                            <tr id="music_box">
                            	<td style="position:relative;"></td>
                            </tr>
                            <tr>
                            	<td>
                            		<input type="text" class="t_input w480" id="music_search_input" />
									<p id="search_status"></p>
									<div id="search_result" style="display: none;">
										<ul class="music_list" id="music_list"></ul>
										<div id="self_set_pager_ui"></div>
									</div>
									<p class="remark">输入想要搜索的歌曲名、专辑名、艺人名，回车即可检索。</p>
                            	</td>
                            </tr>
                            <tr>
                            	<td><textarea name="content" class="input_text" id="textarea" style="width:100%; height: 260px;"></textarea></td>
                            </tr>
                    	</table>
                    	<h4 class="more_title">更多选项</h4>
                    	<div id="more_option">
                    	<table class="table_form" cellpadding="0" cellspacing="0" border="0" width="100%">
                    		<tr>
                                <td>
									<select name="cid" class="t_input">
										{$option}
									</select><p class="remark">选择分类，不选择将默认记录文档类型，而不归类。</p>
                                </td>
                            </tr>
							<tr>
                                <td>
									<lable class="option_lable"><input type="checkbox" class="checkbox" class="checkbox" id="set_top" name="set_top" value="1" /> 置顶</lable>
									<lable class="option_lable"><input type="checkbox" class="checkbox" id="recommend" name="recommend" value="1" /> 推荐</lable>
                                </td>
                            </tr>
                            <tr>
                                <td>
									<input type="text" name="tags" class="t_input w480" /><p class="remark">tags，多个可用空格分开。</p>
                                </td>
                            </tr>
                            <tr>
                                <td>
									<input type="text" name="url_name" class="t_input w480" /><p class="remark">自定义文档的URL名称，用于URL优化，可不填写。</p>
                                </td>
                            </tr>
                            <tr>
                                <td><input type="text" name="keyword" id="keyword" class="t_input w480"><p class="remark">分类关键字，SEO相关，用于页面的 meta keywords，非必填。</p></td>
                            </tr>
                            <tr>
                                <td><textarea name="description" id="description" class="t_input w480" style="height:160px;"></textarea><p class="remark">分类说明，SEO相关，用于页面的 meta description，非必填。</p></td>
                            </tr>
                    	</table>
                    	</div>
                    	<table class="table_form" cellpadding="0" cellspacing="0" border="0" width="100%">
                    		<tr>
                                <td>
                                	<input type="submit" class="submit" value="提交表单" />
				                	&nbsp;&nbsp;&nbsp;
				                	<input type="button" class="submit" value="返回" onclick="window.location.href='{:U('index',array('node'=>$_GET['node']))}';" />
                                </td>
                            </tr>
                    	</table>
						</form>
					</div>
				</div>
				<include file="Public:sidebar" />
			</div>
		</div>
	</body>
</html>