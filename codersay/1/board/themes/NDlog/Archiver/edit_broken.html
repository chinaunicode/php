<!doctype html>
<html>
	<head>
		<title>{:C('SITE_TITLE')}</title>
		<meta charset="utf-8" />
		<include file="Public:commonjs" />
		<link rel="stylesheet" type="text/css" href="../Public/style/layout.css" />
		<script type="text/javascript" src="__JS__/jQuery/jquery.js"></script>
		<script type="text/javascript" src="__JS__/jQuery/plugin/cookie.js"></script>
		<script type="text/javascript" src="__JS__/jQuery/plugin/ajaxUpload.js"></script>
		<script type="text/javascript" src="../Public/js/common.js"></script>
		<include file="Public:dialog" />
		<script type="text/javascript">
			jQuery(document).ready(function($){
				var _total_number = 280;
                var _text_number = getByteLen( $('#textarea').val() );
                if ( getByteLen( $('#textarea').val() ) > _total_number ){
                    $('#TextTotal').html( '已经超出规定的字数' );
                    $('#post').attr('disabled',"true").css({
                        'border-color' : '#ddd',
                        'color' : '#ccc'
                    });
                }else{
                    $('#TextTotal').html( _total_number - _text_number );
                }

				$.get('{:U("getBrokenLast",array("type"=>"broken","number"=>5))}',function(e){
					var _html = '';
					if ( e.status == 1 ){
						var _data = e.data;
						for( var i = 0; i < _data.length; i++ ){
							_html += '<li>';
							_html += '<p>' + _data[i].content + '</p>';
							_html += '<p style="margin-top:10px;color:#999;">发表时间：' + _data[i].create_time + '<span class="c_line">|</span>发布人：' + _data[i].author + '<span class="c_line">|</span>类别：' + _data[i].cid + '<span class="c_line">|</span>查看：' + _data[i].click + '<span class="c_line">|</span>评论：' + _data[i].count + '</p>';
							_html += '</li>';
						}
					}
					$('#broken_list').html(_html);
				},"json");
				
				$('form').submit(function(){
					if ( $.trim( $('#textarea').val() ) == '' ){
						$.alert('请填写碎语内容！');
						return false;
					}
				});
				
				$('#textarea').live('keyup change blur',function(){
				    var _text = $(this).val();
                    var _text_len = getByteLen( _text );
                    var _total = $('#TextTotal');
                    var _num = 280;
                    var _surplus = _num - _text_len;
                    _total.text(_surplus);
                    if ( _surplus < 0 ){
                        $('#post').attr('disabled',"true").css({
                            'border-color' : '#ccc',
                            'color' : '#bbb'
                        });
                    }else{
                        $('#post').removeAttr('style disabled');
                    }
				});

				$('.viewpic').click(function(){
					var href = $(this).attr('href');
					$.dialog({
                		title : '预览：'+href,
                		content : '<img src="'+href+'" />',
                		padding : 10
                	});
					return false;
				});

			});

			function getByteLen( val ){
			    var _len = 0;
			    for ( var i = 0; i < val.length; i++ ){
			        if ( val[i].match( /[^\x00-\xff]/ig ) != null ){
			            _len += 2;
			        }else{
			            _len += 1;
			        }
			    }
			    return _len;
			}


			function ajaxFileUpload(){
                if ($("#filedata").val() == ''){
                    $.alert('请选择要上传的文件！');
                    return false;
                }
                //starting setting some animation when the ajax starts and completes
                $("#loading").ajaxStart(function(){ $(this).show(); }).ajaxComplete(function(){ $(this).hide(); });
        
                $.ajaxFileUpload({
                    url:'{:U("uploadfile/upfile")}', 
                    secureuri:false,
                    fileElementId:'filedata',
                    dataType: 'json',
                    success: function (data, status){
                        //alert(data.msg.url);
                        if(typeof(data.error) != 'undefined'){
                            if(data.error != ''){
                                $.alert(data.error);
                            }else{
                                $.alert(data.msg);
                            }
                        }
                        $("#upimg").after("<div id='img_display' class='upedwrap'><img src='"+data.msg.url+"' width=\"600\" /><input type='hidden' name='img["+data.msg.key+"]' value='"+data.msg.url+"' /></div>");
                        $("#buttonUpload").attr("disabled","disabled");
                        $("#filedata").attr("disabled","disabled");
                        $("#buttonUpload").after(" &nbsp;&nbsp; <input class='submit' type='submit' id='removebanner' onclick=\"return removeFile();\" value='删除' />");
                    },
                    error: function (data, status, e){
                        $.alert(e);
                    }
                });
                return false;
            }
            function removeFile(){
				$.post("{:U('uploadfile/removefile')}",function(data){
					if ( data.status == 1 ){
						$("#buttonUpload").removeAttr("disabled");
						$("#filedata").removeAttr("disabled");
						$("#img_display").remove();
						$("#removebanner").remove();
					}
				},'json');
				return false;
			}

		</script>
		<style type="text/css">
			.t_input				{ padding: 6px; }
			#broken_list li	{ border-top:1px dotted #ccc; padding-top:15px; margin-top:15px; }
			#loading		{ display: none; }
		</style>
	</head>
	<body>
		<div id="wrap">
			<include file="Public:header" />
			<div id="container">
				<div id="sidebar_switch"></div>
				<div id="content">
					<div id="c_warp">
						<form action="{:U('update')}" method="post">
            			<input type="hidden" name="id" value="{$vo.id}" />
            			<input type="hidden" name="type" value="{$vo.type}" />
						<?php
							$omodel = M('Attach');
		                    $olist = $omodel->where("(type='jpg' OR type='jpeg' OR type='png' OR type='bmp' OR type='gif') AND cid='".$vo['id']."'")->select();
							if ( !empty( $olist ) ){
						?>
						<div id='img_display' class='upedwrap'>
						<?php
								foreach ( $olist as $key => $value ){
						?>
							<p>已上传：<a href="__ATTACH__/{$value.folder}/{$value.name}" class="viewpic">{$value["title"]}</a><span class="c_line">|</span><a href="{:U('delOnepic',array('id'=>$value['id']))}">重新上传</a></p>
						<?php
								}
						?>
						</div>
						<?php
							}else{
						?>

						<?php
								if( $_SESSION["other_upload_list"] ){
						?>
						<div class="img upedwrap" id="upimg">
							<span class="file_d_Upload">
								<input id="filedata" type="file" class="attText t_input" style="padding:2px;" name="filedata" disabled="disabled" />
								 &nbsp;&nbsp; 
								<input class="submit" type="button" id="buttonUpload" onclick="return ajaxFileUpload();" disabled="disabled" value="点击上传图片" />
								 &nbsp;&nbsp; 
								<input class='submit' type="button" id='removebanner' onclick="return removeFile();" value="删除" />
								 &nbsp;&nbsp; 
								*若不上传图片默认同步为普通文字消息
							</span>
						</div>
						<div id='img_display' class='upedwrap'>
							<?php
									foreach ( $_SESSION["other_upload_list"] as $key => $value ){
							?>
							<p><img src='__ATTACH__/{$value["savename"]}' width="600" /><input type='hidden' name='img[{$key}]' value='__ATTACH__/{$value["savename"]}' /></p>
							<?php
									}
							?>
						</div>
						<?php
								}else{
						?>
						<div class="img upedwrap" id="upimg">
							<span class="file_d_Upload">
								<input id="filedata" type="file" class="attText t_input" style="padding:2px;" name="filedata" />
								 &nbsp;&nbsp; 
								<input class="submit" type="button" id="buttonUpload" onclick="return ajaxFileUpload();" value="点击上传图片" />
								 &nbsp;&nbsp; 
								*若不上传图片默认同步为普通文字消息
							</span>
						</div>
						<?php
								}
							}
						?>
						<div class="upedwrap" id="loading"><img src="../Public/images/loading.gif" align="absmiddle">上传中...</div>
						<div class="upedwrap"><textarea name="content" class="t_input" id="textarea" style="width:98%; height: 150px;">{$vo.content}</textarea></div>
						<div class="upedwrap"><input type="checkbox" style="vertical-align: middle;" id="QQ" name="sync_QQ" /> 同步至腾讯微博</div>
						<div class="upedwrap">
						    <div style="float: right;">还可以输入 <span style="font-family: Georgia; font-size: 30px; color:#c20000;" id="TextTotal">280</span> 字</div>
						    <div>
										<select name="cid" class="t_input">
											{$option}
										</select><p class="remark" style="margin-top:5px;">选择分类，不选择将默认记录文档类型，而不归类。</p>
	                        </div>
	                        <br />
							<input type="submit" id="post" class="submit" value="发布碎语" />
							 &nbsp;&nbsp; 
							<input class="submit" type="button" value="返回" onclick="window.location.href='{:U('index',array('node'=>$_GET['node']))}';" />
						</div>
						</form>
						<ul id="broken_list" class="upedwrap"></ul>
					</div>
				</div>
				<include file="Public:sidebar" />
			</div>
		</div>
	</body>
</html>